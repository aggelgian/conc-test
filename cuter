#!/usr/bin/env bash

## The arguments are as follows:
## M=$1
## F=$2
## ARGS=$3
## DEPTH=$4 (optional)

DIR=$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )

add_opt(){
    if [ "$1" != "" ]; then
        echo "$1,$2"
    else
        echo $2
    fi
}

if [ $# -ge 3 ]; then
    mod=$1
    func=$2
    args=$3
    depth=25
    opts=

    export ERL_LIBS=${DIR}:${ERL_LIBS}

    beamfile=$mod.beam
    if [ ! -f $beamfile ]; then
        echo -n "File ""$beamfile" "does not exist, "
        erlfile=$mod.erl
        if [ ! -f $erlfile ]; then
            echo "but cannot locate" "$erlfile" "either... exiting"
            exit 1
        fi
        echo -n "creating it... "
        erlc +debug_info $erlfile
        echo "done"
    fi

    shift
    shift
    shift

    if [ "$1" != "" ]; then
        re='^[0-9]+$'
        if [[ $1 =~ $re ]] ; then
          depth=$1
          shift
        fi
    fi

    while [ "$1" != "" ]; do
        PARAM=`echo $1 | awk -F= '{print $1}'`
        VALUE=`echo $1 | awk -F= '{print $2}'`
        case $PARAM in
            -p | --pollers)
                opts=$(add_opt "$opts" "{number_of_pollers, $VALUE}")
                ;;
            -s | --solvers)
                opts=$(add_opt "$opts" "{number_of_solvers, $VALUE}")
                ;;
            -v | --verbose)
                opts=$(add_opt "$opts" "verbose_execution_info")
                ;;
            *)
                ;;
        esac
        shift
    done

    erl -noshell -eval "cuter:run($mod, $func, $args, $depth, [$opts])" -s init stop
else
    echo "Usage: cuter M F '[A1,...,An]' Depth"
fi
